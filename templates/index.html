<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Class Story</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>

<div class="sidebar">
    <h2>Menu</h2>
    <a href="/">Home</a>
    <a href="/stories">Stories</a>
    {% if current_user.is_authenticated %}
        <a href="/liked">Liked</a>
        <a href="/profile">Profile</a>
        <a href="/create">Create</a>
        <hr style="margin: 20px 0; border: none; border-top: 1px solid #ccc;">
        <span style="font-size: 12px; color: #666;">ðŸ‘¤ {{ current_user.username }}</span>
        <a href="/logout" style="background: #dc3545; margin-top: 10px;">Ã‡Ä±kÄ±ÅŸ Yap</a>
    {% else %}
        <a href="/login" style="background: #007bff;">GiriÅŸ Yap</a>
        <a href="/register" style="background: #28a745; margin-top: 10px;">KayÄ±t Ol</a>
    {% endif %}
</div>

<div class="main">
    <h1 class="page-title">Characters</h1>
    <div id="cards" class="cards"></div>
    <div id="loader" class="loader">YÃ¼kleniyor...</div>
</div>

<script>
let page = 1;
const perPage = 6;
const cardsEl = document.getElementById('cards');
const loader = document.getElementById('loader');
let loading = false;
let hasMore = true;
let likedCharacters = new Set();

function createCard(c){
  const el = document.createElement('div');
  el.className = 'card';
  el.id = 'card-' + c.id;
  
  if(c.image){
    const img = document.createElement('img');
    img.src = '/static/uploads/' + c.image;
    img.alt = c.name;
    el.appendChild(img);
    const dl = document.createElement('a');
    dl.href = '/download/' + c.image;
    dl.textContent = 'Download';
    dl.className = 'download-link';
    el.appendChild(dl);
  }
  
  const h3 = document.createElement('h3'); 
  h3.textContent = c.name; 
  el.appendChild(h3);
  
  const p = document.createElement('p'); 
  p.textContent = c.bio; 
  el.appendChild(p);
  
  // Like button
  const btn = document.createElement('button');
  btn.className = 'like-btn';
  btn.id = 'like-btn-' + c.id;
  btn.textContent = likedCharacters.has(c.id) ? 'â¤ï¸ Liked' : 'ðŸ¤ Like';
  btn.onclick = (e) => {
    e.preventDefault();
    toggleLike(c.id, btn);
  };
  el.appendChild(btn);
  
  return el;
}

async function toggleLike(characterId, btn) {
  const isLiked = likedCharacters.has(characterId);
  const endpoint = isLiked ? '/api/unlike_character/' : '/api/like_character/';
  
  try {
    const res = await fetch(endpoint + characterId, { method: 'POST' });
    if (res.ok) {
      if (isLiked) {
        likedCharacters.delete(characterId);
        btn.textContent = 'ðŸ¤ Like';
      } else {
        likedCharacters.add(characterId);
        btn.textContent = 'â¤ï¸ Liked';
      }
    }
  } catch (e) {
    console.error(e);
  }
}

async function loadNext(){
  if(loading || !hasMore) return;
  loading = true;
  loader.textContent = 'YÃ¼kleniyor...';
  try{
    const res = await fetch('/api/characters?page=' + page + '&per_page=' + perPage);
    const data = await res.json();
    data.characters.forEach(c => cardsEl.appendChild(createCard(c)));
    hasMore = data.has_more;
    page += 1;
    if(!hasMore){ loader.textContent = 'Daha fazla yok'; }
  }catch(e){ console.error(e); loader.textContent = 'Hata oluÅŸtu'; }
  loading = false;
}

const observer = new IntersectionObserver(entries => {
  if(entries[0].isIntersecting) loadNext();
}, {root: null, rootMargin: '0px', threshold: 1.0});
observer.observe(loader);

// initial load
loadNext();
</script>

</body>
</html>